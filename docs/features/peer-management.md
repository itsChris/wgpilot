# Peer Management

> **Purpose**: Specifies peer CRUD operations, key generation, client config file generation, QR code provisioning, and AllowedIPs logic per topology mode.
>
> **Related docs**: [../architecture/data-model.md](../architecture/data-model.md), [network-management.md](network-management.md), [../architecture/api-surface.md](../architecture/api-surface.md)
>
> **Implements**: `internal/wg/manager.go` (AddPeer, RemovePeer), `internal/server/handlers/peers.go`, `frontend/src/components/peers/`

---

## Add Peer Operation

1. Generate client keypair.
2. Optionally generate preshared key.
3. Allocate next available IP from network subnet (see [network-management.md](network-management.md) for IP allocation logic).
4. Add peer to WireGuard device via wgctrl.
5. Persist to database.
6. Return generated config for client.

## Client Config Generation

Client `.conf` files are generated on-demand from the database, never stored:

```ini
# Generated by wgpilot — {peer.Name}
[Interface]
PrivateKey = {peer.PrivateKey}
Address = {peer.AllowedIPs}
DNS = {network.DNSServers}

[Peer]
PublicKey = {network.PublicKey}
PresharedKey = {peer.PresharedKey}  # if set
AllowedIPs = {computed_allowed_ips}  # depends on mode
Endpoint = {settings.PublicIP}:{network.ListenPort}
PersistentKeepalive = {peer.PersistentKeepalive}  # if > 0
```

## Allowed IPs in Client Config (by mode)

| Mode | AllowedIPs in client .conf |
|---|---|
| Gateway (full tunnel) | `0.0.0.0/0, ::/0` |
| Gateway (split tunnel) | Network subnet + any custom CIDRs |
| Site-to-site | Remote site subnets |
| Hub-routed | Network subnet (e.g., `10.0.0.0/24`) |

## QR Code

Generated server-side as PNG using `go-qrcode`:

```go
func (h *Handler) PeerQR(w http.ResponseWriter, r *http.Request) {
    conf := h.generatePeerConfig(networkID, peerID)
    png, _ := qrcode.Encode(conf, qrcode.Medium, 256)
    w.Header().Set("Content-Type", "image/png")
    w.Write(png)
}
```

Also rendered client-side via `qrcode.react` in the peer config modal for instant display.

## Provisioning Endpoints

```
GET /api/networks/:id/peers/:pid/config
    Content-Type: text/plain
    Content-Disposition: attachment; filename="wgpilot-{peer.Name}.conf"

GET /api/networks/:id/peers/:pid/qr
    Content-Type: image/png
```

## Frontend Components

The peer management UI consists of:

- **PeerTable** — sortable, filterable table within the network detail page. Each row shows: status dot (green/gray), name, transfer RX/TX, last handshake, actions.
- **PeerForm** — modal form for creating/editing peers. Fields: name, email (optional), role (client/site-gateway), persistent keepalive.
- **PeerConfigModal** — displays QR code + download .conf button + copy-to-clipboard. Shown after peer creation and accessible from peer detail page.
- **PeerDetailPage** — full peer info, config download, per-peer transfer history chart.

## TypeScript Types

```typescript
interface Peer {
    id: number;
    network_id: number;
    name: string;
    email: string;
    public_key: string;
    allowed_ips: string;
    endpoint: string;
    persistent_keepalive: number;
    role: 'client' | 'site-gateway';
    site_networks: string;
    enabled: boolean;
    online: boolean;
    last_handshake: number;
    transfer_rx: number;
    transfer_tx: number;
    created_at: number;
    updated_at: number;
}

---

## v0.3.0 Enhancements (Proposed)

The following proposed features extend peer management:

- [feat-001: Per-Peer Bandwidth Limits](feat-001-per-peer-bandwidth-limits.md) — Add `bandwidth_up_kbps` and `bandwidth_down_kbps` fields to peers
- [feat-006: Active Connection Viewer](feat-006-active-connection-viewer.md) — View active connections per peer, auto-flush conntrack on peer disable/remove
- [feat-008: PersistentKeepalive Display](feat-008-persistent-keepalive-display.md) — Display the kernel's actual keepalive interval in peer status and UI
```
